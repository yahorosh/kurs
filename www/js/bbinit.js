/* MY CODE */   
 
var bbinit; 
$(function(){
    /* Models -----------------------------------------------------------*/    
    
    var d = new Date();
    
    // Students
    
    var Student = Backbone.Model.extend({
        idAttribute: "id_student",
        defaults:{
            id_student: null,
            rec_date: d.getFullYear()+"-" + (d.getMonth() < 9 ? "0" : '') +(d.getMonth()+1)+"-"+d.getDate(),
            name: "",
            order_no: "",
            group: null,
            subjects: null,
            passport:""
        }
    });
    
    var StudentsCollection = Backbone.Collection.extend({
        model: Student,
        url: "/rest/student"   
    });
    
    var Students = new StudentsCollection();

    
    // Groups
    
    var Group = Backbone.Model.extend({
        idAttribute: "id_group",
        defaults:{
            id_group: null,
            name: "",
            department: null
        }
    });
    
    var GroupsCollection = Backbone.Collection.extend({
        model: Group,
        url: "/rest/group"   
    });
    
    
    var Groups = new GroupsCollection();
    
    
    // Deparmments
    
    var Department = Backbone.Model.extend({
        idAttribute: "id_department",
        defaults:{
            id_department: null,
            name: "",
            faculty: null
        }
    });
    
    var DepartmentsCollection = Backbone.Collection.extend({
        model: Department,
        url: "/rest/department"   
    });
    
    
    var Departments = new DepartmentsCollection();
    
    
    // Faculties
    
    var Faculty = Backbone.Model.extend({
        idAttribute: "id_faculty",
        initialize: function(){
            
        },
        defaults:{
            id_faculty: null,
            name: "",
            id_dean: null
        }
    });
    
    var FacultiesCollection = Backbone.Collection.extend({
        model: Faculty,
        url: "/rest/faculty"   
    });
    
    
    var Faculties = new FacultiesCollection();
    
    
    // Deans
    
    var Dean = Backbone.Model.extend({
        idAttribute: "id_dean",
        defaults:{
            id_dean: null,
            name: ""
        }
    });
    
    var DeansCollection = Backbone.Collection.extend({
        model: Dean,
        url: "/rest/dean"   
    });
    
    var Deans = new DeansCollection();
    
    
    // Lecturers
    
    var Lecturer = Backbone.Model.extend({
        idAttribute: "id_lecturer",
        defaults:{
            id_lecturer: null,
            name: "",
            passport: "",
            address : "",
            phone : "",
            degree : "",
            id_chief: null,
            subjects: null,
            salary: ""
        }
    });
    
    var LecturersCollection = Backbone.Collection.extend({
        model: Lecturer,
        url: "/rest/lecturer"   
    });
    
    var Lecturers = new LecturersCollection();
    
    // Subjects
    
    var Subject = Backbone.Model.extend({
        idAttribute: "id_subject",
        defaults:{
            id_subject: null,
            name: ""
        }
    });
    
    var SubjectsCollection = Backbone.Collection.extend({
        model: Subject,
        url: "/rest/subject"   
    });
    
    var Subjects = new SubjectsCollection();
    
    
    /* Views ----------------------------------------------------------------------*/

    var StudentItem = Backbone.View.extend({
        tagName: 'tr',
        events: {
            'click a[href="#edit"]': "action_edit",
            'click a[href="#remove"]': "action_remove"
        },
        render:function(){
            this.$el.html(this.template(this.model.toJSON()));
            return this;
        },
        initialize: function(){
            this.template = _.template(this.options.template);
            
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);
            
        },
        action_edit: function(){
            var editForm = new this.options.formView({
                model:this.model
            });
            editForm.render();
        },
        action_remove: function(){
            
            if(confirm("Remove '"+ this.model.get("name") +"'."+'\n'+" Are you shure?")){
                this.model.destroy();
            }
        }
    });
    
    var BaseForm = Backbone.View.extend({
        tagName:"div",
        events:{
            "click input[name=save]":"action_save",
            "click input[name=saveclose]":"action_saveclose",
            "click input[name=cansel]":"action_cansel"
        },
        initialize:function(){
            this.el_css = {
                height:"400px",
                width:"400px"
            };
            this.template = _.template(this.template);
            this.listenTo(this.model,"change", this.render_form);
            this.listenTo(this.model,"sync", this.render_succ_mess);
        },
        
        closeFancy: function(){
            $.fancybox.close();
        },
        el_css: null,
        render:function(){
            this.$el.css(this.el_css);
            var self = this;
            $.fancybox(this.$el,{
                afterLoad:function(){
                    self.render_form();
                }
            });
            this.render_message();
            return this;
        },
        render_form: function(){
            
            this.$el.html(this.template(this.model.toJSON()));
            var select = this.$('select[name=group]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_group = this.model.get('group') ? this.model.get('group').id_group : 0;
            
            Groups.each(function(Item,i){
                select.append($('<option>')
                    .attr('value',Item.get("id_group"))
                    .html(Item.get("name")));
            });
            this.$("option[value="+id_group+"]", select).attr('selected', 'selected');
            
        },
        render_message: function(text, type){
            text = typeof(text) == 'undefined' ? '' : text;
            type = type == 'success' || type == 'error' || type == 'notify' ? type : '';
            this.$(".message").removeClass().addClass("message").addClass(type);
            this.$(".message").html(text);
        },
        render_succ_mess: function(){
            if(this.close_after_save){
                var self = this;
                setTimeout(function(){ self.action_cansel(); }, 200);
            }
            this.render_errors({});
            this.render_message("Save is succeful!");
            
        },
        render_errors: function(errors){
            var jq = this.el;
            $(".val_error",jq).remove();
            _.each(errors,function(er,i){
                _.each(er,function(m){
                    $("input[name="+i+"]",jq).after($("<div>").html(m).addClass('val_error'));
                });
               
            });
        },
        action_save: function(){
            var data = $(".model").serializeObject();
            var self = this;
            data['group'] = Groups.get(data['group']) ? Groups.get(data['group']).toJSON() : null;
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        action_cansel: function(){
            this.closeFancy();
        },
        close_after_save: false,
        action_saveclose: function(){
            this.close_after_save = true;
            this.action_save();
        }
        
    });
    
    //Student
    
    var StudentForm = BaseForm.extend({
        template:$('.student_form_template').html(),
        render_form: function(){   
            this.$el.html(this.template(this.model.toJSON()));
            var select = this.$('select[name=group]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_group = this.model.get('group') ? this.model.get('group').id_group : 0;
            
            Groups.each(function(Item,i){
                select.append($('<option>')
                    .attr('value',Item.get("id_group"))
                    .html(Item.get("name")));
            });
            //this.$("option[value="+id_group+"]", select).attr('selected', 'selected');
            this.$("select[name=group]").val(id_group);
            
            
            this.renderDept();
            
        },
        initialize:function(){
            this.template = _.template(this.template);
            this.listenTo(this.model,"change", this.render_form);
            this.listenTo(this.model,"sync", this.render_succ_mess);
        },
        events:{
            "click input[name=save]":"action_save",
            "click input[name=saveclose]":"action_saveclose",
            "click input[name=cansel]":"action_cansel",
            "change select[name=group]":"renderDept"
        },
        renderDept: function(){
            if(this.$("select[name=group]").length){
                var g = this.$("select[name=group]").val(); //this.model.get('group')['id_group'];
                var sj = this.$(".subjects table");
                sj.html('');
                var gs = Groups.get(g);
                if(gs){
                    var subjects = gs.get('group_has_subjects');
                    var t = _.template($('.dept_template').html());
                    var model = this.model;

                    _.each(subjects,function(subject,i){

                        var tr = $("<tr>").html(t(subject));
                        $(".credit",tr).attr('name','depts['+i+'][value_credit]').addClass("cr_"+subject.id_group_has_subject);
                        $(".exam",tr).attr('name','depts['+i+'][value_exam]').addClass("ex_"+subject.id_group_has_subject);
                        $(".group_has_subject",tr).attr('name','depts['+i+'][id_group_has_subject]').val(subject.id_group_has_subject);
                        
                        sj.append(tr);
                    });
                    
                    _.each(this.model.get('depts'),function(dept){
                        $(".cr_"+dept.id_group_has_subject, sj).val(dept.value_credit);
                        $(".ex_"+dept.id_group_has_subject, sj).val(dept.value_exam);
                        
                    });
                }

            }
        }
        
    });
    
    
    // Group
    
    var GroupItem = StudentItem.extend({});
    
    var GroupForm = StudentForm.extend({
        el_css: {
                height:"500px",
                width:"500px"
        },
        template:$('.group_form_template').html(),
        action_save: function(){
            var data = $(".model").serializeObject();
            data['group_has_subjects'] = 'group_has_subjects' in data ? data['group_has_subjects'] : [];
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            data['department'] = Departments.get(data['department']) ? Departments.get(data['department']).toJSON() : null;
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        render_form: function(){
            
            this.$el.html(this.template(this.model.toJSON()));
            var select = this.$('select[name=department]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_ = this.model.get('department') ? this.model.get('department').id_department : null;
            
            Departments.each(function(Item,i){
                select.append($('<option>')
                    .attr('value',Item.get("id_department"))
                    .html(Item.get("name")+" - " + Item.get("faculty").name));
            });
            
            this.$("option[value="+id_+"]", select).attr('selected', 'selected');
            
            var s = this.$('.subjects');
            
            //$(".subjects input.model", s).attr('checked',false);
            
            _.each(this.model.get("group_has_subjects"),function(Item){
                var tr = $(".sb_"+Item.id_subject,s);
               // console.log(Item);
                $("input.subject", tr).attr('checked','checked');
                $("select.type",tr).val(Item.type);
                $("select.lecturer",tr).val(Item.id_lecturer);
            });
            
            
        }
    });

    // Department

    var DepartmentItem = StudentItem.extend({});
    
    var DepartmentForm = StudentForm.extend({
        template:$('.department_form_template').html(),
        action_save: function(){
            var data = $(".model").serializeObject();
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            data['faculty'] = Faculties.get(data['faculty']) ? Faculties.get(data['faculty']).toJSON() : null;
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        render_form: function(){
            
            this.$el.html(this.template(this.model.toJSON()));
            var select = this.$('select[name=faculty]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_ = this.model.get('faculty') ? this.model.get('faculty').id_faculty : null;
            
            Faculties.each(function(Item,i){
                select.append($('<option>')
                    .attr('value',Item.get("id_faculty"))
                    .html(Item.get("name")));
            });
            
            this.$("option[value="+id_+"]", select).attr('selected', 'selected');
            
        }
    });

    // Faculty

    var FacultyItem = StudentItem.extend({});
    
    var FacultyForm = StudentForm.extend({
        template:$('.faculty_form_template').html(),
        action_save: function(){
            var data = $(".model").serializeObject();
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        render_form: function(){
            
            this.$el.html(this.template(this.model.toJSON()));
            var select = this.$('select[name=id_dean]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_ = this.model.get('id_dean'); //? this.model.get('faculty').id_faculty : null;
            
            Deans.each(function(Item,i){
                select.append($('<option>')
                    .attr('value',Item.get("id_dean"))
                    .html(Item.get("name")));
            });
            
            this.$("option[value="+id_+"]", select).attr('selected', 'selected');
            
        }
    });    

    // Dean

    var DeanItem = StudentItem.extend({});
    
    var DeanForm = StudentForm.extend({
        template:$('.dean_form_template').html(),
        action_save: function(){
            var data = this.$(".model").serializeObject();
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        render_form: function(){
            this.$el.html(this.template(this.model.toJSON()));
        }
    });
    
    
    
    // Lecturer

    var LecturerItem = StudentItem.extend({});
    
    var LecturerForm = StudentForm.extend({
        template:$('.lecturer_form_template').html(),
        action_save: function(){
            var data = this.$(".model").serializeObject();
                       
            data['subjects'] = 'subjects' in data ? data['subjects'] : [];
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText); self.render_errors(x);
                }
            });
        },
        render_form: function(){
            this.$el.html(this.template(this.model.toJSON()));
            
            var select = this.$('select[name=id_chief]');
            select.html($('<option>').attr('value',0).text('--no-specified--'));
            var id_ = this.model.get('id_chief'); //? this.model.get('faculty').id_faculty : null;
            var id_c = this.model.get('id_lecturer');
            Lecturers.each(function(Item,i){
                if (Item.get('id_lecturer') == id_c) return;
                select.append($('<option>')
                    .attr('value',Item.get("id_lecturer"))
                    .html(Item.get("name")));
            });
            
            
            this.$("option[value="+id_+"]", select).attr('selected', 'selected');
            
            
            
            var s = this.$('.subjects');
            
            $(".subjects input.model", s).attr('checked',false);
            
            _.each(this.model.get("subjects"),function(Item){
                $("input[value="+Item.id_subject+"]", s).attr('checked','checked');
            });
            //$("input", s).attr('checked',true);
            
            
        }
    });
    
    // Subject

    var SubjectItem = StudentItem.extend({});
    
    var SubjectForm = StudentForm.extend({
        template:$('.subject_form_template').html(),
        action_save: function(){
            var data = $(".model").serializeObject();
            var self = this;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            this.model.set(data);
            this.model.save({},{
                error:function(a,b,c){
                    eval("var x = "+b.responseText), self.render_errors(x);
                }
            });
        },
        render_form: function(){
            this.$el.html(this.template(this.model.toJSON()));
        }
    });
    
    
    // Common list
    
    var ListView = Backbone.View.extend({
        render: function(){
            this.$(".count").html(this.model.length);            
        },
        events:{
            'click a[href="#create"]' : "action_create",
            'click a[href="#removeselected"]' : "action_removeSelected"
        },
        initialize: function(){
            
            this.itemTemplate = this.$('.item_template').remove().html();
            this.listenTo(this.model, "add", this.render_one);
            this.listenTo(this.model, 'reset', this.render_list);
            this.listenTo(this.model, 'all', this.render);
            this.model.fetch();
            
        },
        render_list: function(){
            
            this.model.each(this.render_one, this);
        },
        render_one: function(item){
            if(item.isNew()){
                
            };
            var itemView = new this.options.itemView({
                model:item,
                template: this.itemTemplate,
                formView: this.options.formView
            });
            this.$('tbody').append(itemView.render().el);
        },
        action_create: function(){
            var newItem = new this.model.model({},{
                collection:this.model
            });
            
            this.listenTo(newItem, "sync", function(){
                this.model.add(newItem);
            });
            
            var addForm = new this.options.formView({
                model: newItem                                  
            });
                
            addForm.render();
            
        },
        action_removeSelected: function(){
            
        }

    }

    );


    bbinit = function(page){
        switch (page) {
            case "students":
                Groups.fetch();

                var List = new ListView({
                    model: Students,
                    el: $('.student_list_template'),
                    formView: StudentForm,
                    itemView: StudentItem
                });

                break;
            case "groups":
                Departments.fetch();

                var List = new ListView({
                    model: Groups,
                    el: $('.group_list_template'),
                    formView: GroupForm,
                    itemView: GroupItem
                });

                break; 
            case "departments":
                
                Faculties.fetch();

                var List = new ListView({
                    model: Departments,
                    el: $('.department_list_template'),
                    formView: DepartmentForm,
                    itemView: DepartmentItem
                });

                break; 
            case "faculties":
                Deans.fetch();
                var List = new ListView({
                    model: Faculties,
                    el: $('.faculty_list_template'),
                    formView: FacultyForm,
                    itemView: FacultyItem
                });

                break;
            
            case "subjects":
                
                var List = new ListView({
                    model: Subjects,
                    el: $('.subject_list_template'),
                    formView: SubjectForm,
                    itemView: SubjectItem
                });

                break;
            
            case "deans":
                
                Faculties.fetch();
                var List = new ListView({
                    model: Deans,
                    el: $('.dean_list_template'),
                    formView: DeanForm,
                    itemView: DeanItem
                });

                break;
            case "lecturers":
                
                var List = new ListView({
                    model: Lecturers,
                    el: $('.lecturer_list_template'),
                    formView: LecturerForm,
                    itemView: LecturerItem
                });

                break;
        }
    }


}); 


















   
   
   
   
   